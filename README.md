# overthrust-tests -  Assynchronous Subsampling Implementation

About Implementation:

The base C code was generated by DEVITO [Version](https://github.com/speglich/devito/commit/ac2b8f60ee8b9faa39b935d0f0dd40c6a9842997)

The only edited code was the Forward C and the code is available in `C_DEVITO/devito-jitcache-uid4061/6dc6e522c3b426b91a451ea3833e8e44a9116ade.c`

The edited code adds:

* Necessary Headers at beginning of the code (l: 14)

```c
#include "sys/types.h"
#include "unistd.h"
#include "sys/stat.h"
#include "fcntl.h"
#include "errno.h"
#include "stdlib.h"
#include "aio.h"
#include "stdio.h"
#include "string.h"
```

* Open the scratch file (l: 60)

```c
  int step = 4;
  int file;

  if ((file = open("/scr01/test.data", O_WRONLY | O_CREAT | O_TRUNC,
      S_IRUSR | S_IWUSR | S_IRGRP | S_IROTH)) == -1)
  {
      perror("Cannot open output file\n"); exit(1);
  }
```
** YOU SHOULD CHANGE THE PATH TO A VALID DIRECTORY IN YOUR ENVIRONMENT **
** STEP VARIABLE DEFINES HOW MUCH OF THE TIMESTEPS WILL BE WRITTEN 1 / STEPS **

* call the `aio_write` with the right parameters (don't forget the offset :p ). Here we are writing the position `t0` while compute `t1` so we are always writing the previous computed time step.  (l: 70)

```c
    struct aiocb aiocb;
    if (!(time % step)) {
      memset(&aiocb, 0, sizeof(struct aiocb));

      aiocb.aio_fildes = file;
      aiocb.aio_nbytes = u_size;
      aiocb.aio_offset = u_size * counter;
      aiocb.aio_buf = u[t0];

      if (aio_write(&aiocb) == -1) {
        printf(" Error at aio_write(): %s\n", strerror(errno));
        close(file);
        exit(2);
      }
    }
```

* Wait until write the write finishes.... And after writing all timesteps, close the file.
```c
 if (!(time % step)) {
      /* Wait until completion */
      while (aio_error (&aiocb) == EINPROGRESS);

      int err = aio_error(&aiocb);
      int ret = aio_return(&aiocb);

      if (err != 0) {
        printf (" Error at aio_error() : %s\n", strerror (err));
        close (file);
        exit(2);
      }

      if (ret != aiocb.aio_nbytes) {
        printf(" Error at aio_return()\n");
        close(file);
        exit(2);
      }

      counter++;
    }
```

* Changed in simple.py the `cflags`.

```python

class MyOwnCompiler(GNUCompiler):
    def __init__(self, *args, **kwargs):
        super(MyOwnCompiler, self).__init__(*args, **kwargs)
        self.cflags.append("-lrt")


### Make sure Devito is aware of this new Compiler class
compiler_registry['mycompiler'] = MyOwnCompiler
configuration.add("compiler", "custom", list(compiler_registry), callback=lambda i: compiler_registry[i]())

### Then, what remains to be done is asking Devito to use MyOwnCompiler

configuration['compiler'] = 'mycompiler'
````

Usage:

```
make
```

This should run all the experiments.
